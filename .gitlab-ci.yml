stages:
  - install
  - build
  - code-quality
  - publish
  - test

variables:
  NPM_REGISTRY: "https://eugit.randstadgis.com/api/v4/projects/${CI_PROJECT_ID}/packages/npm/"
  SAST_EXCLUDED_ANALYZERS: "nodejs-scan-sast" # this only scans js files, doesn't work with ts

# Install dependencies
install_dependencies:
  stage: install
  image: node:20.11.1
  tags:
    - global
  before_script:
    - echo "@cone:registry=https://eugit.randstadgis.com/api/v4/groups/ssc-grp-c-one/-/packages/npm/" > .npmrc
    - echo "//eugit.randstadgis.com/api/v4/groups/ssc-grp-c-one/-/packages/npm/:_authToken=${GITLAB_ACCESS_TOKEN}" >> .npmrc
  script:
    - npm ci
  cache:
    paths:
      - node_modules/
  artifacts:
    expire_in: 1 hour
    paths:
      - node_modules/

build:
  stage: build
  image: node:20.11.1
  tags:
    - global
  script:
    - npm run build
  cache:
    paths:
      - node_modules/
      - dist/
  artifacts:
    paths:
      - dist/
    expire_in: 1 hour

test:
  stage: code-quality
  image: node:20.11.1
  tags:
    - global
  script:
    - npm run test
  cache:
    paths:
      - node_modules/

lint:
  stage: code-quality
  image: node:20.11.1
  tags:
    - global
  script:
    - npm run lint
  cache:
    paths:
      - node_modules/

prettier:
  stage: code-quality
  image: node:20.11.1
  tags:
    - global
  script:
    - npm run prettier
  cache:
    paths:
      - node_modules/
sast:
  stage: code-quality
  tags:
    - global
  cache:
    paths:
      - dist/
      - node_modules/
secret_detection:
  stage: code-quality
  tags:
    - global
include:
  - template: Security/SAST.gitlab-ci.yml
  - template: Security/Secret-Detection.gitlab-ci.yml

# Publish the npm package
# Publish the npm package
publish:
  stage: publish
  image: node:20.11.1
  tags:
    - global
  script:
    - echo "@cone:registry=$NPM_REGISTRY" > .npmrc
    - echo "//eugit.randstadgis.com/api/v4/projects/${CI_PROJECT_ID}/packages/npm/:_authToken=${CI_JOB_TOKEN}" >> .npmrc
    - curl -I $NPM_REGISTRY
    - npm publish
  only:
    - main
  allow_failure: false
  cache:
    paths:
      - dist/
      - node_modules/
